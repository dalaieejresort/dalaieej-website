Subject: Build Diagnostic Auth Route
Context: The OAuth flow returns "No code provided". We need to debug exactly what parameters Cloudbeds is sending back to the redirect URI.
Task: Replace the entire content of app/api/cloudbeds/auth/route.ts with this diagnostic code.
Code:
import { NextRequest, NextResponse } from 'next/server';
import axios from 'axios';
export async function GET(request: NextRequest) { const { searchParams } = request.nextUrl; const code = searchParams.get('code'); const error = searchParams.get('error'); const errorDescription = searchParams.get('error_description');
// 1. If we have an error from Cloudbeds, show it clearly if (error) { return NextResponse.json({ status: 'Cloudbeds Returned an Error', error_code: error, details: errorDescription, full_params: Object.fromEntries(searchParams.entries()) }, { status: 400 }); }
// 2. If we have the Code, attempt the exchange immediately if (code) { try { const tokenResponse = await axios.post('https://hotels.cloudbeds.com/api/v1.1/access_token', { grant_type: 'authorization_code', client_id: process.env.CLOUDBEDS_CLIENT_ID, client_secret: process.env.CLOUDBEDS_CLIENT_SECRET, redirect_uri: "https://098718ea-addb-41fe-93a7-6bb3eb8e8db0-00-jrmc4jbez5aj.picard.replit.dev/api/cloudbeds/auth", code: code, });
return NextResponse.json({ success: true, message: "SUCCESS! Copy the refresh_token below into your Secrets.", refresh_token: tokenResponse.data.refresh_token, access_token: tokenResponse.data.access_token });

} catch (err: any) { return NextResponse.json({ status: 'Exchange Failed', error: err.response?.data || err.message, sent_redirect_uri: "https://098718ea-addb-41fe-93a7-6bb3eb8e8db0-00-jrmc4jbez5aj.picard.replit.dev/api/cloudbeds/auth" }, { status: 500 }); }

}
// 3. If neither, show what we DID receive so we can debug return NextResponse.json({ status: 'Missing Parameters', message: 'No code or error received from Cloudbeds.', received_url: request.url, received_params: Object.fromEntries(searchParams.entries()) }, { status: 400 }); }

**Action:** Update the file to this version so we can see the real error.